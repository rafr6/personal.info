<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Vault ‚Äî Final PDF Fixed</title>
  <style>
    body{font-family:Arial, sans-serif;background:#f4f6fa;margin:0;padding:0;color:#111}
    .wrap{max-width:900px;margin:20px auto;padding:16px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.1);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:20px}
    input,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    button{background:#0b74de;color:#fff;border:none;cursor:pointer}
    .folders{margin-top:12px}
    .folder{padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:12px;background:#fafafa}
    .file-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:#fff;margin:6px 0;border:1px solid #eee}
    .muted{color:#666;font-size:13px}
    iframe,embed,video,img{width:100%;height:60vh;border:1px solid #ccc;border-radius:8px}
    @media(max-width:720px){ iframe,embed,video,img{height:45vh} }
    .actions button{margin-left:6px;padding:6px 8px;font-size:13px}
    .danger{background:#d9534f}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="loginCard">
      <h1>üîê File Vault</h1>
      <div class="muted">‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
      <div style="margin-top:10px">
        <input id="pw" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®" />
        <button id="btnLogin">‡¶≤‡¶ó‡¶á‡¶®</button>
      </div>
    </div>

    <div class="card" id="appCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>üìÅ File Vault</h1>
        <button id="btnLogout">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
      </div>
      <hr>
      <input id="newFolderName" type="text" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" />
      <button id="btnCreate">‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</button>

      <div id="foldersContainer" class="folders"></div>

      <h3>Preview</h3>
      <div id="previewArea" class="previewArea"></div>
    </div>
  </div>

<script>
const DB_NAME = 'filevault_pdf_fixed';
const STORE = 'files';
let db = null;

function openDb(){
  return new Promise((res, rej)=>{
    const r = indexedDB.open(DB_NAME,1);
    r.onupgradeneeded = ev=>{
      const idb = ev.target.result;
      if(!idb.objectStoreNames.contains(STORE)){
        const os = idb.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
        os.createIndex('folder','folder',{unique:false});
      }
    };
    r.onsuccess=e=>{db=e.target.result;res(db);}
    r.onerror=e=>rej(e);
  });
}

function addFile(folder,file){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite');
    const st=tx.objectStore(STORE);
    const rec={folder,name:file.name,type:file.type,size:file.size,blob:file,created:Date.now()};
    const req=st.add(rec);
    req.onsuccess=()=>res(true);
    req.onerror=e=>rej(e);
  });
}

function getFiles(folder){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readonly');
    const st=tx.objectStore(STORE).index('folder');
    const req=st.getAll(IDBKeyRange.only(folder));
    req.onsuccess=()=>res(req.result);
    req.onerror=e=>rej(e);
  });
}

function deleteFile(id){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite');
    const st=tx.objectStore(STORE);
    const req=st.delete(id);
    req.onsuccess=()=>res(true);
    req.onerror=e=>rej(e);
  });
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
function readableSize(b){if(b<1024)return b+" B";if(b<1024*1024)return (b/1024).toFixed(1)+" KB";return (b/1024/1024).toFixed(1)+" MB";}

// UI
const pwInput=document.getElementById('pw');
document.getElementById('btnLogin').onclick=()=>{
  const p=pwInput.value.trim();
  const saved=localStorage.getItem('fv_pass');
  if(!saved){localStorage.setItem('fv_pass',p);start();}
  else if(p===saved)start();
  else alert('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°');
};
document.getElementById('btnLogout').onclick=()=>{
  document.getElementById('appCard').style.display="none";
  document.getElementById('loginCard').style.display="block";
};

async function start(){
  await openDb();
  document.getElementById('loginCard').style.display="none";
  document.getElementById('appCard').style.display="block";
  render();
}

document.getElementById('btnCreate').onclick=()=>render();

async function render(){
  const cont=document.getElementById('foldersContainer');
  cont.innerHTML='';
  const folder=document.getElementById('newFolderName').value.trim()||'Default';
  const div=document.createElement('div');
  div.className='folder';
  div.innerHTML=`<b>üìÇ ${escapeHtml(folder)}</b> 
    <input type="file" multiple>`;
  const list=document.createElement('div');
  const files=await getFiles(folder);
  if(files.length===0){
    list.innerHTML='<div class="muted">‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶≤‡¶ø</div>';
  }else{
    for(const f of files){
      const item=document.createElement('div');
      item.className='file-item';
      item.innerHTML=`<span>${escapeHtml(f.name)} <span class="muted">(${readableSize(f.size)})</span></span>`;
      const actions=document.createElement('div');
      const b1=document.createElement('button');b1.textContent='Preview';b1.onclick=()=>preview(f);
      const b2=document.createElement('button');b2.textContent='Download';b2.onclick=()=>download(f);
      const b3=document.createElement('button');b3.textContent='Delete';b3.className='danger';b3.onclick=async()=>{await deleteFile(f.id);render();};
      actions.append(b1,b2,b3);
      item.appendChild(actions);
      list.appendChild(item);
    }
  }
  div.querySelector('input').onchange=async e=>{
    for(const f of e.target.files){await addFile(folder,f);}
    render();
  };
  div.appendChild(list);
  cont.appendChild(div);
}

function preview(f){
  const area=document.getElementById('previewArea');
  area.innerHTML='';
  const url=URL.createObjectURL(f.blob);
  if(f.type==='application/pdf'||f.name.endsWith('.pdf')){
    const em=document.createElement('embed');
    em.src=url;em.type='application/pdf';
    area.appendChild(em);
    const link=document.createElement('div');
    link.innerHTML=`<a href="${url}" target="_blank">‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá PDF ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</a>`;
    area.appendChild(link);
  }else if(f.type.startsWith('video/')){
    const v=document.createElement('video');v.controls=true;v.src=url;area.appendChild(v);
  }else if(f.type.startsWith('image/')){
    const i=document.createElement('img');i.src=url;area.appendChild(i);
  }else{
    const a=document.createElement('a');a.href=url;a.textContent='‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®';area.appendChild(a);
  }
}
function download(f){
  const url=URL.createObjectURL(f.blob);
  const a=document.createElement('a');a.href=url;a.download=f.name;a.click();
}
</script>
</body>
</html>
